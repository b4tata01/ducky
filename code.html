<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Vocabulary Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- THEME RESTORED: PURPLE/PINK --- */
        :root {
            --primary-color: #8E24AA; /* Deep Purple */
            --primary-dark: #6A1B9A;
            --secondary-color: #D81B60; /* Deep Pink accent */
            --bg-color: #F3E5F5; /* Light background */
            --text-color: #333;
            --card-bg: #ffffff;
            --sidebar-width: 280px;
        }

        body.dark-mode {
            --primary-color: #AB47BC;
            --primary-dark: #8E24AA;
            --secondary-color: #F06292;
            --bg-color: #121212;
            --text-color: #f5f5f5;
            --card-bg: #1E1E1E;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
            margin: 0;
        }

        /* --- ANIMATED SIDEBAR --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--card-bg);
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            transform: translateX(-105%); 
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-right: 3px solid var(--primary-color);
        }

        #sidebar.active {
            transform: translateX(0);
        }

        /* Title is lowered further by increasing top padding */
        .sidebar-header {
            padding: 100px 20px 40px 20px; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-menu li a {
            display: block;
            padding: 15px 30px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 5px solid transparent;
            font-weight: 500;
            font-size: 1rem;
        }

        .sidebar-menu li a:hover {
            background-color: rgba(142, 36, 170, 0.08);
            color: var(--primary-color);
            padding-left: 35px;
        }

        .sidebar-menu li a.active {
            background-color: rgba(142, 36, 170, 0.15);
            color: var(--primary-color);
            border-left-color: var(--secondary-color);
        }

        /* --- OVERLAY --- */
        #overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #overlay.visible { display: block; opacity: 1; }

        /* --- MAIN CONTENT & BUTTON COVERAGE FIX --- */
        #main-content {
            padding: 80px 20px 20px 90px;
            max-width: 1200px;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
             #main-content {
                padding: 80px 10px 10px 80px; 
            }
        }

        .hero-section {
            background: linear-gradient(120deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px;
            padding: 40px;
            color: white;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(142, 36, 170, 0.3);
            animation: fadeInDown 0.8s ease;
        }

        .feature-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            height: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-bottom: 4px solid transparent;
            cursor: default;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-bottom-color: var(--secondary-color);
        }
        
        /* --- BUTTONS --- */
        .btn-menu {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--card-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        .btn-menu:hover { transform: scale(1.1); background: var(--primary-color); color: white; }

        .btn-theme {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--secondary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 1.2rem;
        }
        .btn-theme:hover { transform: rotate(20deg); }


        /* --- WORD LIST (HIDDEN REVEAL STYLE) --- */
        .word-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid var(--primary-color);
            transition: background 0.2s;
        }

        .word-text { font-weight: 700; font-size: 1.1rem; color: var(--primary-color); }
        
        .definition-text {
            display: none;
            margin-left: 20px;
            color: var(--text-color);
            font-style: italic;
            animation: fadeIn 0.4s;
        }
        .btn-reveal {
            background-color: rgba(142, 36, 170, 0.1); 
            color: var(--primary-color);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reveal:hover { background-color: var(--primary-color); color: white; }
        
        /* --- FLASHCARD (3D FLIP) --- */
        .flashcard-container {
            perspective: 1000px;
            height: 220px;
            cursor: pointer;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-radius: 20px;
        }
        .flashcard-inner.flipped {
            transform: rotateY(180deg);
        }
        .fc-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .fc-front {
            background-color: var(--card-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        .fc-back {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-color));
            color: white;
            transform: rotateY(180deg);
        }


        /* --- GAME BOX STYLES --- */
        .game-box {
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eee;
            margin-bottom: 20px;
            background: var(--card-bg);
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .game-counter {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-color);
            padding: 5px 10px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--secondary-color);
        }
        
        /* --- MATCHING GAME SPECIFIC --- */
        .match-btn { 
            margin: 5px; 
            background: var(--card-bg); 
            color: var(--text-color); 
            border: 1px solid #ddd; 
            padding: 10px 15px; 
            border-radius: 8px;
            transition: all 0.2s;
        }
        .match-btn:hover:not(.selected) { background: var(--bg-color); }
        .match-btn.selected { 
            background: var(--secondary-color); 
            color: white; 
            border-color: var(--secondary-color); 
            transform: scale(1.05); 
            box-shadow: 0 4px 8px rgba(216, 27, 96, 0.4);
        }
        .match-btn.matched { 
            background: #4CAF50 !important; 
            color: white !important; 
            border-color: #4CAF50 !important; 
            animation: fadeOutMatch 0.5s forwards; 
            pointer-events: none; 
        }
        @keyframes fadeOutMatch {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }

        /* --- FILL-IN-THE-BLANK GAME SPECIFIC --- */
        .fitb-question {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-style: italic;
        }
        .fitb-blank {
            color: var(--secondary-color);
            font-weight: bold;
            padding: 2px 10px;
            border-bottom: 2px dashed var(--secondary-color);
            margin: 0 5px;
            white-space: nowrap;
        }
        .fitb-option {
            width: 100%;
            margin-bottom: 8px;
            background: var(--card-bg);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            transition: all 0.2s;
        }
        .fitb-option:hover:not(.disabled) {
            background: var(--primary-color);
            color: white;
        }
        .fitb-option.correct {
            background: #4CAF50; /* Green */
            border-color: #4CAF50;
            color: white;
            box-shadow: 0 2px 5px rgba(76, 175, 80, 0.5);
            animation: pulse 0.5s 1;
        }
        .fitb-option.incorrect {
            background: #F44336; /* Red */
            border-color: #F44336;
            color: white;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }


        /* Win Message for Games */
        .game-win-message {
            text-align: center;
            padding: 30px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        /* --- ANIMATED 'PLAY AGAIN' BUTTON (On-Click only, now using theme colors) --- */
        @keyframes glowPulse {
            /* Use primary and secondary color for a purple/pink glow */
            0% { box-shadow: 0 0 0 0 var(--primary-color); transform: scale(1); }
            50% { box-shadow: 0 0 15px 5px var(--secondary-color); transform: scale(1.03); }
            100% { box-shadow: 0 0 0 0 var(--primary-color); transform: scale(1); }
        }

        .game-win-message .btn-light {
            font-size: 1.1rem;
            transition: transform 0.2s; 
            border: 1px solid white; /* Add border for better visibility of the button itself */
            background-color: white;
            color: var(--secondary-color);
            font-weight: 700 !important;
        }
        .game-win-message .btn-light:hover {
            transform: scale(1.05);
            background-color: var(--bg-color);
        }
        
        /* Class applied by JS on click for single pulse */
        .btn-light.clicked-pulse {
            animation: glowPulse 0.5s 1 ease-out; 
        }

    </style>
</head>
<body>

    <button class="btn-menu" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
    <button class="btn-theme" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></button>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-shapes"></i> Vocab Master</h3>
            <p>Interactive Learning</p>
        </div>
        
        <ul class="sidebar-menu">
            <li><a href="#" onclick="loadTab('home', this)" class="active"><i class="fas fa-th-large me-3"></i>Dashboard</a></li>
            <li><a href="#" onclick="loadTab('unit1', this)"><i class="fas fa-briefcase me-3"></i>Unit 1: Business</a></li>
            <li><a href="#" onclick="loadTab('unit2', this)"><i class="fas fa-graduation-cap me-3"></i>Unit 2: Education</a></li>
            <li><a href="#" onclick="loadTab('unit3', this)"><i class="fas fa-heartbeat me-3"></i>Unit 3: Health</a></li>
            <li><a href="#" onclick="loadTab('unit5', this)"><i class="fas fa-city me-3"></i>Unit 5: Architecture</a></li>
            <li><a href="#" onclick="loadTab('unit6', this)"><i class="fas fa-cogs me-3"></i>Unit 6: Systems</a></li>
        </ul>

        <div class="p-3 text-center small text-muted opacity-75" style="font-style: italic;">
            Duck Production for a world filled with ducks
        </div>
    </div>

    <div id="main-content">
        
        <div id="view-home">
            
            <div class="hero-section">
                <h1>Welcome Back, Student!</h1>
                <p>Ready to master your English vocabulary? Select a unit to begin.</p>
            </div>
            
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="feature-card">
                        <div class="mb-3" style="color: var(--primary-color);"><i class="fas fa-list-alt fa-3x"></i></div>
                        <h5>Active Lists</h5>
                        <p class="text-muted small">Study words with our hidden-definition lists to test your recall actively.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="feature-card">
                        <div class="mb-3" style="color: var(--secondary-color);"><i class="fas fa-layer-group fa-3x"></i></div>
                        <h5>Smart Flashcards</h5>
                        <p class="text-muted small">Flip through cards to memorize core meanings effectively.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="feature-card">
                        <div class="mb-3 text-success"><i class="fas fa-puzzle-piece fa-3x"></i></div>
                        <h5>Interactive Games</h5>
                        <p class="text-muted small">Connect words to definitions in our matching mini-games.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-unit" class="content-box" style="display: none;">
            <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                <div>
                    <h2 id="u-title" style="color: var(--primary-color); margin:0; font-weight:700;">Unit Title</h2>
                </div>
                <i class="fas fa-book-reader fa-3x" style="color: var(--secondary-color); opacity: 0.2;"></i>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    
                    <h5 class="mb-3 text-uppercase text-muted fw-bold"><i class="fas fa-list me-2"></i>Study List</h5>
                    <div id="word-list-container">
                        </div>

                    <div class="game-box">
                        <div class="game-header">
                            <h5 class="m-0 text-uppercase text-muted fw-bold"><i class="fas fa-pencil-alt me-2"></i>Fill in the Blank</h5>
                            <span id="fitb-counter" class="game-counter">0 / 0</span>
                        </div>
                        
                        <div id="fitb-question-area">
                            <p class="fitb-question" id="fitb-definition-text">
                                The act of stopping something from happening is called __________.
                            </p>
                            <div id="fitb-options-area" class="d-grid gap-2">
                                </div>
                        </div>

                        <div id="fitb-win" class="game-win-message mt-3">
                            <h4 class="mb-3"><i class="fas fa-check-circle me-2"></i>Fill-in-the-Blank Complete!</h4>
                            <button class="btn btn-light fw-bold" onclick="initFITBGame(true)">Play Again</button>
                        </div>
                    </div>

                </div>

                <div class="col-lg-6">
                    <div class="card border-0 shadow-none mb-4" style="background: transparent;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="m-0 text-uppercase text-muted fw-bold"><i class="fas fa-clone me-2"></i>Flashcards</h5>
                            <span id="fc-count" class="badge bg-primary rounded-pill">1 / 10</span>
                        </div>
                        <div class="flashcard-container" onclick="flipFlashcard()">
                            <div class="flashcard-inner" id="fc-inner">
                                <div class="fc-face fc-front">
                                    <h2 id="fc-front-text">Word</h2>
                                    <small class="mt-3 text-muted"><i class="fas fa-hand-pointer"></i> Tap to Flip</small>
                                </div>
                                <div class="fc-face fc-back">
                                    <p id="fc-back-text" class="lead fw-bold">Definition</p>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-outline-secondary rounded-pill px-4" onclick="navCard(-1)">Prev</button>
                            <button class="btn btn-outline-secondary rounded-pill px-4" onclick="navCard(1)">Next</button>
                        </div>
                    </div>

                    <div class="game-box">
                        <div class="game-header">
                            <h5 class="m-0 text-uppercase text-muted fw-bold"><i class="fas fa-puzzle-piece me-2"></i>Match Game</h5>
                            <span id="match-counter-1" class="game-counter">Matched 0 / 0</span>
                        </div>
                        <div id="match-area-1" class="d-flex flex-wrap justify-content-center gap-2"></div>
                        <div id="match-win-1" class="game-win-message mt-3">
                            <h4 class="mb-3"><i class="fas fa-check-circle me-2"></i>Game Complete!</h4>
                            <button class="btn btn-light fw-bold" onclick="initMatchingGame(1, true)">Play Again</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- DATA SOURCE ---
        const vocabDB = {
            unit1: {
                title: "Unit 1: Business & Economics",
                words: [
                    {w: "Consumer", d: "A person who buys goods or services"},
                    {w: "Cost", d: "Amount of money needed to buy something"},
                    {w: "Discount", d: "A reduction in price"},
                    {w: "Export", d: "To send goods to another country"},
                    {w: "Import", d: "To bring products in from another country"},
                    {w: "Labour", d: "Work, especially hard physical work"},
                    {w: "Profit", d: "Money earned after costs are paid"},
                    {w: "Purchase", d: "To buy something"},
                    {w: "Transport", d: "System of moving people or goods"}
                ],
                fitb_questions: [
                    {
                        q: "The main goal of any company is to maximize __________, the money earned after all costs are paid.",
                        a: "Profit",
                        d: ["Consumer", "Labour", "Transport"]
                    },
                    {
                        q: "A sudden drop in prices, often to encourage sales, is known as a ________.",
                        a: "Discount",
                        d: ["Purchase", "Cost", "Import"]
                    },
                    {
                        q: "To send domestically produced goods to foreign nations for sale is to __________.",
                        a: "Export",
                        d: ["Import", "Purchase", "Cost"]
                    },
                    {
                        q: "The price you pay for an item is its __________.",
                        a: "Cost",
                        d: ["Discount", "Consumer", "Profit"]
                    }
                ]
            },
            unit2: {
                title: "Unit 2: Education & Innovation",
                words: [
                    {w: "Adviser", d: "A person who gives professional help"},
                    {w: "Campus", d: "The grounds of a university"},
                    {w: "Emphasis", d: "Special importance given to something"},
                    {w: "Innovation", d: "A new idea, method, or invention"},
                    {w: "Institution", d: "An established organization (e.g. college)"},
                    {w: "Reference", d: "Mention or source of information"},
                    {w: "Statement", d: "Something said or written formally"},
                    {w: "Concept", d: "An idea or principle"},
                    {w: "Theory", d: "A set of ideas to explain something"}
                ],
                fitb_questions: [
                    {
                        q: "A university's grounds and main buildings are referred to as the ________.",
                        a: "Campus",
                        d: ["Institution", "Reference", "Concept"]
                    },
                    {
                        q: "The special importance or weight given to a particular subject in a class is called __________.",
                        a: "Emphasis",
                        d: ["Adviser", "Innovation", "Theory"]
                    },
                    {
                        q: "Creating a new method or product is a clear sign of __________, which is key to development.",
                        a: "Innovation",
                        d: ["Statement", "Emphasis", "Reference"]
                    },
                    {
                        q: "If you need professional career help, you might consult a career __________.",
                        a: "Adviser",
                        d: ["Institution", "Concept", "Theory"]
                    }
                ]
            },
            unit3: {
                title: "Unit 3: Health & Medicine",
                words: [
                    {w: "Antibiotic", d: "Medicine that kills bacteria"},
                    {w: "Outbreak", d: "Sudden appearance of disease"},
                    {w: "Prescription", d: "Doctorâ€™s instruction for medicine"},
                    {w: "Prevention", d: "Act of stopping something from happening"},
                    {w: "Recover", d: "To become well again"},
                    {w: "Vaccine", d: "Substance to prevent disease"},
                    {w: "Virus", d: "Small organism causing illness"},
                    {w: "Aid", d: "A helpful action or assistance"},
                    {w: "Balance", d: "A state where things are equal"},
                ],
                fitb_questions: [
                    {
                        q: "A doctor will write a __________ which outlines the medicine needed for a patient.",
                        a: "Prescription",
                        d: ["Vaccine", "Outbreak", "Aid"]
                    },
                    {
                        q: "The public health goal of stopping illness before it starts is called __________.",
                        a: "Prevention",
                        d: ["Recover", "Virus", "Balance"]
                    },
                    {
                        q: "When a new disease suddenly appears and spreads rapidly in an area, it's called an __________.",
                        a: "Outbreak",
                        d: ["Prescription", "Antibiotic", "Prevention"]
                    },
                    {
                        q: "A chemical substance used to kill bacteria and treat infections is an __________.",
                        a: "Antibiotic",
                        d: ["Virus", "Vaccine", "Aid"]
                    }
                ]
            },
            unit5: {
                title: "Unit 5: Architecture",
                words: [
                    {w: "Abandon", d: "To leave something forever"},
                    {w: "Acquire", d: "To buy or get something"},
                    {w: "Collapse", d: "To fall down suddenly"},
                    {w: "Convert", d: "To change from one thing to another"},
                    {w: "Expand", d: "To increase in size"},
                    {w: "Maintain", d: "To keep in good condition"},
                    {w: "Transform", d: "To change completely in form"},
                    {w: "Anticipate", d: "To expect something will happen"},
                    {w: "Appreciate", d: "To recognize how good something is"},
                ],
                fitb_questions: [
                    {
                        q: "After the earthquake, many old structures were at risk of __________.",
                        a: "Collapse",
                        d: ["Abandon", "Acquire", "Expand"]
                    },
                    {
                        q: "A contractor must constantly __________ the building to ensure it remains in good condition.",
                        a: "Maintain",
                        d: ["Transform", "Convert", "Anticipate"]
                    },
                    {
                        q: "The construction company aims to __________ their size next year by hiring more staff.",
                        a: "Expand",
                        d: ["Collapse", "Acquire", "Maintain"]
                    },
                    {
                        q: "To completely change the shape or function of a building is to __________ it.",
                        a: "Transform",
                        d: ["Convert", "Appreciate", "Anticipate"]
                    }
                ]
            },
            unit6: {
                title: "Unit 6: Systems",
                words: [
                    {w: "Capacity", d: "Total amount that can be contained"},
                    {w: "Consumption", d: "The act of using, eating or drinking"},
                    {w: "Decline", d: "A decrease in something"},
                    {w: "Generate", d: "To produce something"},
                    {w: "Implement", d: "To make changes happen"},
                    {w: "Reservoir", d: "Artificial lake that stores water"},
                    {w: "Sufficient", d: "As much as is needed"},
                    {w: "Challenge", d: "Something requiring great effort"},
                    {w: "Cycle", d: "Set of events that repeat"}
                ],
                fitb_questions: [
                    {
                        q: "The total amount of liquid a dam can hold is its maximum storage __________.",
                        a: "Capacity",
                        d: ["Consumption", "Decline", "Reservoir"]
                    },
                    {
                        q: "Using large amounts of electricity leads to high energy __________.",
                        a: "Consumption",
                        d: ["Generate", "Sufficient", "Cycle"]
                    },
                    {
                        q: "The large artificial lake that collects and stores water for a city is called a __________.",
                        a: "Reservoir",
                        d: ["Capacity", "Challenge", "Decline"]
                    },
                    {
                        q: "A significant drop in the number of users is a sales __________.",
                        a: "Decline",
                        d: ["Implement", "Consumption", "Sufficient"]
                    }
                ]
            }
        };

        // --- STATE ---
        let currUnitKey = null;
        let fcIndex = 0;
        let matchState = {
            1: { sel: null, count: 0, total: 0, gameData: null }
        };
        let fitbState = {
            currentQuestionIndex: 0,
            correctCount: 0,
            questions: [],
            totalQuestions: 0
        };

        // --- GLOBAL UTILITIES ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- GLOBAL UI FUNCTIONS ---
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('visible');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            icon.className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function loadTab(key, element) {
            // Close menu on selection
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('visible');

            // Update Sidebar Active State
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
            if (element) {
                const linkElement = element.closest('a');
                if (linkElement) {
                    linkElement.classList.add('active');
                }
            }

            if (key === 'home') {
                document.getElementById('view-home').style.display = 'block';
                document.getElementById('view-unit').style.display = 'none';
            } else {
                document.getElementById('view-home').style.display = 'none';
                document.getElementById('view-unit').style.display = 'block';
                renderUnit(key);
            }
        }

        // --- UNIT RENDER LOGIC ---
        function renderUnit(key) {
            currUnitKey = key;
            const data = vocabDB[key];
            
            document.getElementById('u-title').innerText = data.title;

            // 1. Render Word List
            const listContainer = document.getElementById('word-list-container');
            listContainer.innerHTML = '';
            data.words.forEach(item => {
                const div = document.createElement('div');
                div.className = 'word-card';
                const safeId = `def-${item.w.replace(/[^a-zA-Z0-9]/g,'')}`;
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="word-text">${item.w}</span>
                        <span class="definition-text" id="${safeId}">${item.d}</span>
                    </div>
                    <button class="btn-reveal" onclick="revealDef(this, '${safeId}')">
                        <i class="fas fa-eye"></i> Reveal
                    </button>
                `;
                listContainer.appendChild(div);
            });

            // 2. Reset Games
            fcIndex = 0;
            updateFlashcardUI();
            initMatchingGame(1); 
            initFITBGame();
        }

        // --- WORD LIST FUNCTION ---
        function revealDef(btn, defId) {
            const defEl = document.getElementById(defId);
            if (defEl.style.display === 'block') {
                defEl.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-eye"></i> Reveal';
                btn.style.background = "rgba(142, 36, 170, 0.1)"; 
                btn.style.color = "var(--primary-color)";
            } else {
                defEl.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
                btn.style.background = "var(--primary-color)";
                btn.style.color = "white";
            }
        }

        // --- FLASHCARD FUNCTIONS (3D FLIP) ---
        function updateFlashcardUI() {
            if (!currUnitKey) return;
            const data = vocabDB[currUnitKey].words;
            const card = document.getElementById('fc-inner');
            card.classList.remove('flipped');
            
            setTimeout(() => {
                document.getElementById('fc-front-text').innerText = data[fcIndex].w;
                document.getElementById('fc-back-text').innerText = data[fcIndex].d;
                document.getElementById('fc-count').innerText = `${fcIndex + 1} / ${data.length}`;
            }, 200);
        }

        function flipFlashcard() {
            document.getElementById('fc-inner').classList.toggle('flipped');
        }

        function navCard(dir) {
            const len = vocabDB[currUnitKey].words.length;
            fcIndex = (fcIndex + dir + len) % len;
            updateFlashcardUI();
        }

        // --- MATCHING GAME (GAME 1) ---
        function updateMatchCounter(gameId) {
            const state = matchState[gameId];
            document.getElementById(`match-counter-${gameId}`).innerText = `Matched ${state.count} / ${state.total}`;
        }

        function initMatchingGame(gameId, isPlayAgain = false) {
            const container = document.getElementById(`match-area-${gameId}`);
            
            // Apply single-run animation to the button only when it's a "Play Again" click
            if(isPlayAgain) {
                const winEl = document.getElementById(`match-win-${gameId}`);
                const btn = winEl.querySelector('.btn-light');
                if (btn) {
                    btn.classList.add('clicked-pulse');
                    setTimeout(() => {
                        btn.classList.remove('clicked-pulse');
                    }, 500); // Duration matches CSS animation
                }
            }

            container.innerHTML = '';
            document.getElementById(`match-win-${gameId}`).style.display = 'none';
            
            if (!currUnitKey) return;
            const data = vocabDB[currUnitKey].words;

            // Use up to 7 pairs
            let pairs = [];
            data.slice(0, 7).forEach(item => { 
                pairs.push({ txt: item.w, type: 'w', id: item.w });
                pairs.push({ txt: item.d, type: 'd', id: item.w });
            });
            
            shuffleArray(pairs);

            // Set state for counter
            matchState[gameId].total = pairs.length / 2;
            matchState[gameId].count = 0;
            matchState[gameId].sel = null;
            updateMatchCounter(gameId);

            pairs.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'btn match-btn';
                btn.innerText = p.txt;
                btn.onclick = () => handleMatch(btn, p, gameId);
                container.appendChild(btn);
            });
        }

        function handleMatch(btn, item, gameId) {
            const state = matchState[gameId];

            if(btn.classList.contains('matched') || state.count === state.total) return;

            if(!state.sel) {
                // First selection
                state.sel = { btn, item };
                btn.classList.add('selected');
            } else {
                const first = state.sel;
                if(first.btn === btn) {
                    // Clicking same button again
                    btn.classList.remove('selected');
                    state.sel = null;
                    return;
                }

                if(first.item.id === item.id && first.item.type !== item.type) {
                    // Match found
                    btn.classList.remove('selected');
                    first.btn.classList.remove('selected');
                    
                    // Add matched class for fade out animation
                    btn.classList.add('matched');
                    first.btn.classList.add('matched');
                    
                    state.count++;
                    updateMatchCounter(gameId);
                    state.sel = null;

                    // Check for win
                    if (state.count === state.total) {
                         // Show win message for the specific game
                        setTimeout(() => {
                            document.getElementById(`match-area-${gameId}`).innerHTML = '';
                            document.getElementById(`match-win-${gameId}`).style.display = 'block';
                        }, 600);
                    }
                } else {
                    // No match
                    btn.classList.add('btn-danger');
                    first.btn.classList.add('btn-danger');
                    setTimeout(() => {
                        btn.classList.remove('btn-danger', 'selected');
                        first.btn.classList.remove('btn-danger', 'selected');
                        state.sel = null;
                    }, 500);
                }
            }
        }


        // --- FILL-IN-THE-BLANK GAME ---

        function updateFITBCounter() {
            document.getElementById('fitb-counter').innerText = `${fitbState.correctCount} / ${fitbState.totalQuestions}`;
        }

        function generateFITBQuestions() {
            if (!currUnitKey || !vocabDB[currUnitKey].fitb_questions) return [];
            
            const rawQuestions = vocabDB[currUnitKey].fitb_questions;
            const questions = [];

            rawQuestions.forEach(item => {
                const correctAnswer = item.a;
                const questionText = item.q;
                
                // Combine correct answer and distractors
                let choices = [correctAnswer, ...item.d];
                choices = shuffleArray(choices);

                questions.push({
                    word: correctAnswer,
                    questionText: questionText,
                    choices: choices
                });
            });

            return shuffleArray(questions);
        }

        function initFITBGame(isPlayAgain = false) {
            // Apply single-run animation to the button only when it's a "Play Again" click
            if(isPlayAgain) {
                const winEl = document.getElementById('fitb-win');
                const btn = winEl.querySelector('.btn-light');
                if (btn) {
                    btn.classList.add('clicked-pulse');
                    setTimeout(() => {
                        btn.classList.remove('clicked-pulse');
                    }, 500); // Duration matches CSS animation
                }
            }

            document.getElementById('fitb-win').style.display = 'none';
            document.getElementById('fitb-question-area').style.display = 'block';
            
            fitbState.questions = generateFITBQuestions();
            fitbState.totalQuestions = fitbState.questions.length;
            fitbState.currentQuestionIndex = 0;
            fitbState.correctCount = 0;
            updateFITBCounter();
            renderCurrentFITBQuestion();
        }

        function renderCurrentFITBQuestion() {
            if (fitbState.currentQuestionIndex >= fitbState.totalQuestions) {
                // Game over
                return;
            }

            const questionData = fitbState.questions[fitbState.currentQuestionIndex];
            const definitionEl = document.getElementById('fitb-definition-text');
            const optionsArea = document.getElementById('fitb-options-area');

            // Render the question, replacing the '__________' placeholder with a dashed line (empty span).
            definitionEl.innerHTML = questionData.questionText.replace(
                "__________", 
                `<span class="fitb-blank">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>` 
            );

            optionsArea.innerHTML = '';
            questionData.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'btn fitb-option';
                btn.innerText = choice;
                btn.onclick = () => handleFITBAnswer(btn, choice, questionData.word);
                optionsArea.appendChild(btn);
            });
        }

        function handleFITBAnswer(selectedBtn, selectedAnswer, correctAnswer) {
            const optionsArea = document.getElementById('fitb-options-area');
            const allButtons = optionsArea.querySelectorAll('.fitb-option');

            // Disable all buttons to prevent double-clicking
            allButtons.forEach(btn => btn.classList.add('disabled'));

            if (selectedAnswer === correctAnswer) {
                selectedBtn.classList.add('correct');
                fitbState.correctCount++;
                updateFITBCounter();
            } else {
                selectedBtn.classList.add('incorrect');
                // Highlight the correct answer
                allButtons.forEach(btn => {
                    if (btn.innerText === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }

            // Move to the next question after a delay
            setTimeout(() => {
                fitbState.currentQuestionIndex++;
                if (fitbState.currentQuestionIndex < fitbState.totalQuestions) {
                    renderCurrentFITBQuestion();
                } else {
                    // Game finished
                    document.getElementById('fitb-question-area').style.display = 'none';
                    document.getElementById('fitb-win').style.display = 'block';
                }
            }, 1500);
        }

        
        // Load home tab on initial page load
        document.addEventListener('DOMContentLoaded', () => {
            const homeLink = document.querySelector('[onclick*="loadTab(\'home\', this)"]');
            if(homeLink) {
                loadTab('home', homeLink);
            }
        });
    </script>
</body>
</html>